# Стратегия тестирования ML Pipeline

## Обзор

Этот документ описывает комплексную стратегию тестирования для ML пайплайна диагностики рака молочной железы.

## Структура тестов

### 1. Unit тесты (Модульные тесты)

#### `test_data_loader.py`
- **Назначение**: Тестирование модуля загрузки данных
- **Покрытие**:
 - Загрузка данных из файла
 - Валидация данных
 - Анализ данных
 - Обработка ошибок (файл не найден, некорректный формат)
 - Сохранение отчетов анализа

#### `test_data_preprocessor.py`
- **Назначение**: Тестирование модуля предобработки данных
- **Покрытие**:
 - Очистка данных (пропуски, дубликаты, выбросы)
 - Разделение на признаки и целевую переменную
 - Масштабирование признаков
 - Кодирование целевой переменной
 - Разделение на тренировочную и тестовую выборки

#### `test_model_trainer.py`
- **Назначение**: Тестирование модуля обучения моделей
- **Покрытие**:
 - Инициализация моделей
 - Обучение отдельных моделей
 - Кросс-валидация
 - Выбор лучшей модели
 - Настройка гиперпараметров
 - Получение важности признаков

#### `test_metrics_calculator.py`
- **Назначение**: Тестирование модуля расчета метрик
- **Покрытие**:
 - Расчет классификационных метрик
 - Оценка модели
 - Создание визуализаций
 - Анализ важности признаков
 - Генерация отчетов

#### `test_storage_manager.py`
- **Назначение**: Тестирование модуля управления хранилищем
- **Покрытие**:
 - Сохранение/загрузка моделей
 - Сохранение/загрузка метрик
 - Работа с DataFrame
 - Интеграция с облачными хранилищами (S3, GCS)
 - Создание резервных копий

### 2. Интеграционные тесты

#### `test_integration.py`
- **Назначение**: Тестирование взаимодействия всех компонентов
- **Покрытие**:
 - Полный пайплайн от загрузки до сохранения результатов
 - Передача данных между компонентами
 - Обработка ошибок на уровне пайплайна
 - Тестирование производительности

## Инструменты тестирования

### Основные инструменты
- **unittest**: Стандартная библиотека Python для unit тестов
- **pytest**: Расширенный фреймворк тестирования
- **mock**: Создание mock объектов для изоляции тестов
- **coverage**: Анализ покрытия кода тестами

### Дополнительные инструменты
- **pytest-cov**: Интеграция coverage с pytest
- **pytest-xdist**: Параллельный запуск тестов
- **pytest-mock**: Упрощенные mock объекты для pytest

## Запуск тестов

### Быстрый запуск
```bash
# Запуск всех тестов
make test

# Запуск конкретного теста
python -m unittest tests.test_data_loader

# Запуск с pytest
pytest tests/
```

### Расширенный запуск
```bash
# Запуск с покрытием кода
pytest tests/ --cov=etl --cov=config --cov-report=html

# Запуск только unit тестов
pytest tests/ -m "not integration"

# Запуск только интеграционных тестов
pytest tests/test_integration.py

# Комплексный запуск с отчетом
python run_tests.py
```

## Стратегия mock тестирования

### Принципы
1. **Изоляция**: Каждый unit тест должен тестировать только одну функцию/метод
2. **Независимость**: Тесты не должны зависеть от внешних ресурсов
3. **Скорость**: Тесты должны выполняться быстро
4. **Надежность**: Тесты должны быть стабильными и воспроизводимыми

### Mock объекты
- **Модели ML**: Замена на простые mock объекты для unit тестов
- **Файловые операции**: Mock для операций чтения/записи файлов
- **Облачные сервисы**: Mock для S3, GCS API
- **Визуализации**: Mock для matplotlib операций

## Метрики качества тестов

### Покрытие кода
- **Цель**: > 80% покрытия для всех модулей
- **Критичные модули**: > 90% покрытия
- **Исключения**: Визуализации, логирование

### Производительность
- **Unit тесты**: < 1 секунды на тест
- **Интеграционные тесты**: < 5 минут общее время
- **Полный набор**: < 10 минут

## Continuous Integration

### GitHub Actions (рекомендуется)
```yaml
name: Tests
on: [push, pull_request]
jobs:
 test:
 runs-on: ubuntu-latest
 strategy:
 matrix:
 python-version: [3.8, 3.9, 3.10]
 steps:
 - uses: actions/checkout@v2
 - name: Set up Python
 uses: actions/setup-python@v2
 with:
 python-version: ${{ matrix.python-version }}
 - name: Install dependencies
 run: |
 pip install -r requirements.txt
 - name: Run tests
 run: |
 python run_tests.py
```

## Тестовые данные

### Синтетические данные
- Используются в unit тестах для скорости и контроля
- Покрывают граничные случаи
- Не зависят от внешних файлов

### Реальные данные
- Подмножество Wisconsin Breast Cancer Dataset
- Используются в интеграционных тестах
- Проверяют работу с реальными данными

## Обработка ошибок в тестах

### Типы тестируемых ошибок
1. **Ошибки ввода**: Некорректные файлы, неправильные параметры
2. **Ошибки данных**: Пустые датасеты, несовместимые размеры
3. **Ошибки системы**: Недостаток памяти, недоступность файлов
4. **Ошибки ML**: Проблемы с обучением моделей

### Стратегии тестирования ошибок
- **assertRaises**: Проверка ожидаемых исключений
- **Mock side_effect**: Симуляция системных ошибок
- **Граничные случаи**: Тестирование экстремальных значений

## Отчетность

### Автоматические отчеты
- **HTML отчет покрытия**: `htmlcov/index.html`
- **Текстовый отчет тестов**: `test_report.txt`
- **JUnit XML**: Для интеграции с CI/CD

### Метрики для мониторинга
- Процент прохождения тестов
- Покрытие кода по модулям
- Время выполнения тестов
- Количество упавших тестов

## Рекомендации по разработке

### Для новых функций
1. Сначала напишите тест (TDD подход)
2. Убедитесь в покрытии основных сценариев
3. Добавьте тесты на ошибки
4. Проверьте производительность

### Для изменений существующего кода
1. Запустите существующие тесты
2. Обновите тесты при необходимости
3. Добавьте новые тесты для новой функциональности
4. Проверьте общее покрытие

## Troubleshooting

### Частые проблемы
1. **Import ошибки**: Проверьте PYTHONPATH и структуру проекта
2. **Mock не работает**: Убедитесь в правильном patch декораторе
3. **Тесты падают случайно**: Проверьте на race conditions
4. **Медленные тесты**: Оптимизируйте или вынесите в отдельную категорию

### Отладка тестов
```bash
# Подробный вывод
pytest tests/ -v -s

# Только первый упавший тест
pytest tests/ -x

# Отладка конкретного теста
pytest tests/test_data_loader.py::TestDataLoader::test_load_data_success -v -s
```

## Заключение

Комплексная стратегия тестирования обеспечивает:
- **Качество**: Высокую надежность кода
- **Уверенность**: В корректности изменений
- **Скорость**: Быструю разработку благодаря автоматизации
- **Поддерживаемость**: Легкость внесения изменений

Следование этой стратегии гарантирует высокое качество ML пайплайна и готовность к промышленному использованию.
